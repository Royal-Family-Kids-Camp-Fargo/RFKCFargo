<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
    xmlns:pro="http://www.liquibase.org/xml/ns/pro"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd
                        http://www.liquibase.org/xml/ns/pro http://www.liquibase.org/xml/ns/pro/liquibase-pro-latest.xsd
                        http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">
    <!-- Starting from production database on July 17, 2024 -->

    <!-- Create custom types -->
    <changeSet id="1" author="liquibase">
        <sql> CREATE TYPE public.enum_user_location_role AS ENUM ('admin', 'supporter'); </sql>
    </changeSet>

    <!-- Create functions -->
    <changeSet id="2" author="liquibase">
        <sql>
            CREATE FUNCTION public.handle_input() RETURNS trigger 
            LANGUAGE plpgsql AS $$ 
            BEGIN
                NEW.email = lower(NEW.email); 
                RETURN NEW; 
            END
            $$;
        </sql>
    </changeSet>

    <changeSet id="3" author="liquibase">
        <sql> CREATE FUNCTION public.handle_lower_email() RETURNS trigger LANGUAGE plpgsql AS $$
            BEGIN NEW.email = lower(NEW.email); NEW.code = gen_random_uuid(); RETURN NEW; END $$; </sql>
    </changeSet>

    <changeSet id="4" author="liquibase">
        <sql> CREATE FUNCTION public.handle_password_reset_insert_conflict() RETURNS trigger
            LANGUAGE plpgsql AS $$ BEGIN INSERT INTO password_reset (email, code) VALUES (NEW.email,
            NEW.code) ON CONFLICT (email) DO UPDATE SET NEW.code = EXCLUDED.code; RETURN NEW; END $$; </sql>
    </changeSet>


    <changeSet id="5" author="liquibase">
        <sql> CREATE FUNCTION public.increment_reset_count() RETURNS trigger LANGUAGE plpgsql AS
            $func$ BEGIN -- Increment reset_count when a password reset request is made
            NEW.reset_count = COALESCE(OLD.reset_count, 0) + 1; RETURN NEW; END $func$; </sql>
    </changeSet>

    <changeSet id="6" author="liquibase">
        <sql> CREATE FUNCTION public.update_code() RETURNS trigger LANGUAGE plpgsql AS $$ BEGIN
            NEW.code = gen_random_uuid(); RETURN NEW; END $$; </sql>
    </changeSet>

    <!-- Create tables -->
    <changeSet id="7" author="liquibase">
        <createTable tableName="location">
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="8" author="liquibase">
        <createTable tableName="user">
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="first_name" type="varchar(35)" />
            <column name="last_name" type="varchar(30)" />
            <column name="phone_number" type="varchar(25)" />
            <column name="created_at" type="timestamp with time zone"
                defaultValueComputed="CURRENT_TIMESTAMP" />
            <column name="updated_at" type="timestamp with time zone"
                defaultValueComputed="CURRENT_TIMESTAMP" />
            <column name="email" type="varchar(100)">
                <constraints unique="true" />
            </column>
            <column name="devii_roleid" type="bigint">
                <constraints unique="true" />
            </column>
            <column name="location_id" type="bigint" defaultValue="1">
                <constraints nullable="false" />
            </column>
            <column name="assigned_to" type="bigint" />
            <column name="city" type="varchar(150)" />
        </createTable>
    </changeSet>

    <changeSet id="9" author="liquibase">
        <createTable tableName="pipeline">
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="name" type="varchar(32)" />
            <column name="type" type="varchar(20)" />
            <column name="location_id" type="integer">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="10" author="liquibase">
        <createTable tableName="pipeline_status">
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="pipeline_id" type="integer">
                <constraints nullable="false" />
            </column>
            <column name="order" type="integer">
                <constraints nullable="false" />
            </column>
            <column name="name" type="varchar(150)" />
        </createTable>
    </changeSet>

    <changeSet id="11" author="liquibase">
        <createTable tableName="forms">
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="name" type="varchar(150)" />
            <column name="default_pipeline_id" type="integer">
                <constraints nullable="false" />
            </column>
            <column name="location_id" type="integer">
                <constraints nullable="false" />
            </column>
            <column name="archived" type="boolean" defaultValueBoolean="false">
                <constraints nullable="false" />
            </column>
            <column name="locationId" type="integer" />
            <column name="pipelineId" type="integer" />
            <column name="defaultPipelineId" type="integer" />
        </createTable>
    </changeSet>

    <changeSet id="12" author="liquibase">
        <createTable tableName="sections">
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="name" type="varchar(150)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(500)" defaultValue="" />
            <column name="form_id" type="integer" />
            <column name="order" type="integer">
                <constraints nullable="false" />
            </column>
            <column name="formId" type="integer" />
        </createTable>
    </changeSet>

    <changeSet id="13" author="liquibase">
        <createTable tableName="question">
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="question" type="varchar(500)" />
            <column name="description" type="varchar(500)" />
            <column name="answer_type" type="varchar(30)" />
            <column name="order" type="integer">
                <constraints nullable="false" />
            </column>
            <column name="section_id" type="integer" />
            <column name="archived" type="boolean" defaultValueBoolean="false" />
            <column name="required" type="boolean" defaultValueBoolean="false" />
            <column name="created_at" type="timestamp with time zone"
                defaultValueComputed="CURRENT_TIMESTAMP" />
            <column name="updated_at" type="timestamp with time zone"
                defaultValueComputed="CURRENT_TIMESTAMP" />
            <column name="sectionId" type="integer" />
        </createTable>
    </changeSet>

    <changeSet id="14" author="liquibase">
        <createTable tableName="multiple_choice_answers">
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="question_id" type="integer" />
            <column name="answer" type="varchar(1000)" />
            <column name="questionId" type="integer" />
        </createTable>
    </changeSet>

    <changeSet id="15" author="liquibase">
        <createTable tableName="submission">
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="user_id" type="integer" />
            <column name="form_id" type="integer" />
            <column name="started_at" type="timestamp with time zone"
                defaultValueComputed="CURRENT_TIMESTAMP" />
            <column name="finished_at" type="timestamp with time zone" />
            <column name="userId" type="integer" />
            <column name="formId" type="integer" />
        </createTable>
    </changeSet>

    <changeSet id="16" author="liquibase">
        <createTable tableName="answer">
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="question_id" type="integer" />
            <column name="submission_id" type="integer" />
            <column name="user_id" type="integer" />
            <column name="answer" type="varchar(1000)" />
            <column name="created_at" type="timestamp with time zone"
                defaultValueComputed="CURRENT_TIMESTAMP" />
            <column name="updated_at" type="timestamp with time zone"
                defaultValueComputed="CURRENT_TIMESTAMP" />
            <column name="questionId" type="integer" />
            <column name="userId" type="integer" />
            <column name="submissionId" type="integer" />
        </createTable>
    </changeSet>

    <changeSet id="17" author="liquibase">
        <createTable tableName="donation">
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="user_id" type="integer" />
            <column name="amount" type="integer" />
            <column name="created_at" type="timestamp with time zone"
                defaultValueComputed="CURRENT_TIMESTAMP" />
            <column name="updated_at" type="timestamp with time zone"
                defaultValueComputed="CURRENT_TIMESTAMP" />
            <column name="userId" type="integer" />
        </createTable>
    </changeSet>

    <changeSet id="18" author="liquibase">
        <createTable tableName="password_reset">
            <column name="email" type="varchar(254)">
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="reset_count" type="integer" defaultValue="0" />
            <column name="test" type="text" />
        </createTable>
    </changeSet>

    <changeSet id="19" author="liquibase">
        <createTable tableName="user_pipeline_status">
            <column name="user_id" type="integer">
                <constraints nullable="false" />
            </column>
            <column name="pipeline_status_id" type="integer">
                <constraints nullable="false" />
            </column>
            <column name="pipeline_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addPrimaryKey tableName="user_pipeline_status" columnNames="user_id, pipeline_id"
            constraintName="user_pipeline_status_pk" />
    </changeSet>

    <changeSet id="20" author="liquibase">
        <createTable tableName="tags">
            <column name="id" type="smallint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="name" type="text" />
        </createTable>
        <addUniqueConstraint tableName="tags" columnNames="name" constraintName="no_dup_name" />
    </changeSet>

    <changeSet id="21" author="liquibase">
        <createTable tableName="user_tags">
            <column name="user_id" type="bigint" />
            <column name="tag_id" type="smallint" />
        </createTable>
    </changeSet>

    <changeSet id="22" author="liquibase">
        <createTable tableName="user_notes">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="note" type="text">
                <constraints nullable="false" />
            </column>
            <column name="created_at" type="timestamp without time zone"
                defaultValueComputed="now()" />
            <column name="updated_at" type="timestamp without time zone"
                defaultValueComputed="now()" />
            <column name="created_by_id" type="integer">
                <constraints nullable="false" />
            </column>
            <column name="user_id" type="integer">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="23" author="liquibase">
        <createTable tableName="sms_template">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="user_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="is_shared" type="boolean" defaultValueBoolean="false">
                <constraints nullable="false" />
            </column>
            <column name="title" type="varchar(100)" />
            <column name="template" type="text">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="24" author="liquibase">
        <createTable tableName="email_test">
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="text" type="text" />
        </createTable>
    </changeSet>

    <!-- Create indexes -->
    <changeSet id="25" author="liquibase">
        <createIndex indexName="email_lower_idx" tableName="password_reset" unique="true">
            <column name="lower(email::text)" />
        </createIndex>
    </changeSet>

    <!-- Add foreign key constraints -->
    <changeSet id="26" author="liquibase">
        <addForeignKeyConstraint baseTableName="user" baseColumnNames="location_id"
            constraintName="user_location_fk"
            referencedTableName="location" referencedColumnNames="id"
            onDelete="CASCADE" onUpdate="CASCADE" />

        <addForeignKeyConstraint baseTableName="user" baseColumnNames="assigned_to"
            constraintName="assigned_to_user_fk"
            referencedTableName="user" referencedColumnNames="id" />

        <addForeignKeyConstraint baseTableName="pipeline" baseColumnNames="location_id"
            constraintName="location_pipeline_fk"
            referencedTableName="location" referencedColumnNames="id"
            onDelete="CASCADE" onUpdate="CASCADE" />

        <addForeignKeyConstraint baseTableName="pipeline_status" baseColumnNames="pipeline_id"
            constraintName="pipleline_status_fk"
            referencedTableName="pipeline" referencedColumnNames="id"
            onDelete="CASCADE" onUpdate="CASCADE" />

        <addForeignKeyConstraint baseTableName="forms" baseColumnNames="locationId"
            constraintName="forms_locationId_fkey"
            referencedTableName="location" referencedColumnNames="id"
            onDelete="SET NULL" onUpdate="CASCADE" />

        <addForeignKeyConstraint baseTableName="forms" baseColumnNames="pipelineId"
            constraintName="forms_pipelineId_fkey"
            referencedTableName="pipeline" referencedColumnNames="id"
            onDelete="SET NULL" onUpdate="CASCADE" />

        <addForeignKeyConstraint baseTableName="forms" baseColumnNames="defaultPipelineId"
            constraintName="forms_defaultPipelineId_fkey"
            referencedTableName="pipeline" referencedColumnNames="id"
            onDelete="SET NULL" onUpdate="CASCADE" />

        <addForeignKeyConstraint baseTableName="sections" baseColumnNames="formId"
            constraintName="sections_formId_fkey"
            referencedTableName="forms" referencedColumnNames="id"
            onDelete="SET NULL" onUpdate="CASCADE" />

        <addForeignKeyConstraint baseTableName="question" baseColumnNames="sectionId"
            constraintName="question_sectionId_fkey"
            referencedTableName="sections" referencedColumnNames="id"
            onDelete="SET NULL" onUpdate="CASCADE" />

        <addForeignKeyConstraint baseTableName="multiple_choice_answers"
            baseColumnNames="questionId"
            constraintName="multiple_choice_answers_questionId_fkey"
            referencedTableName="question" referencedColumnNames="id"
            onDelete="SET NULL" onUpdate="CASCADE" />

        <addForeignKeyConstraint baseTableName="submission" baseColumnNames="userId"
            constraintName="submission_userId_fkey"
            referencedTableName="user" referencedColumnNames="id"
            onDelete="SET NULL" onUpdate="CASCADE" />

        <addForeignKeyConstraint baseTableName="submission" baseColumnNames="formId"
            constraintName="submission_formId_fkey"
            referencedTableName="forms" referencedColumnNames="id"
            onDelete="SET NULL" onUpdate="CASCADE" />

        <addForeignKeyConstraint baseTableName="answer" baseColumnNames="questionId"
            constraintName="answer_questionId_fkey"
            referencedTableName="question" referencedColumnNames="id"
            onDelete="SET NULL" onUpdate="CASCADE" />

        <addForeignKeyConstraint baseTableName="answer" baseColumnNames="userId"
            constraintName="answer_userId_fkey"
            referencedTableName="user" referencedColumnNames="id"
            onDelete="SET NULL" onUpdate="CASCADE" />

        <addForeignKeyConstraint baseTableName="answer" baseColumnNames="submissionId"
            constraintName="answer_submissionId_fkey"
            referencedTableName="submission" referencedColumnNames="id"
            onDelete="SET NULL" onUpdate="CASCADE" />

        <addForeignKeyConstraint baseTableName="donation" baseColumnNames="userId"
            constraintName="donation_userId_fkey"
            referencedTableName="user" referencedColumnNames="id"
            onDelete="SET NULL" onUpdate="CASCADE" />

        <addForeignKeyConstraint baseTableName="user_pipeline_status" baseColumnNames="user_id"
            constraintName="user_status_userId_fkey"
            referencedTableName="user" referencedColumnNames="id"
            onDelete="CASCADE" onUpdate="CASCADE" />

        <addForeignKeyConstraint baseTableName="user_pipeline_status"
            baseColumnNames="pipeline_status_id"
            constraintName="user_status_pipelineStatusId_fkey"
            referencedTableName="pipeline_status" referencedColumnNames="id"
            onDelete="CASCADE" onUpdate="CASCADE" />

        <addForeignKeyConstraint baseTableName="user_pipeline_status" baseColumnNames="pipeline_id"
            constraintName="user_status_pipeline_id_fk"
            referencedTableName="pipeline" referencedColumnNames="id"
            onDelete="CASCADE" onUpdate="CASCADE" />

        <addForeignKeyConstraint baseTableName="user_tags" baseColumnNames="user_id"
            constraintName="user_tags_user_id_user_fk"
            referencedTableName="user" referencedColumnNames="id" />

        <addForeignKeyConstraint baseTableName="user_tags" baseColumnNames="tag_id"
            constraintName="user_tags_tag_id_tag"
            referencedTableName="tags" referencedColumnNames="id" />

        <addForeignKeyConstraint baseTableName="user_notes" baseColumnNames="created_by_id"
            constraintName="created_by_id_user_fk"
            referencedTableName="user" referencedColumnNames="id" />

        <addForeignKeyConstraint baseTableName="user_notes" baseColumnNames="user_id"
            constraintName="user_id_user_fk"
            referencedTableName="user" referencedColumnNames="id" />

        <addForeignKeyConstraint baseTableName="sms_template" baseColumnNames="user_id"
            constraintName="constraint_1"
            referencedTableName="user" referencedColumnNames="id" />
    </changeSet>

    <!-- Create triggers -->
    <changeSet id="27" author="liquibase">
        <sql> CREATE TRIGGER handle_input BEFORE INSERT OR UPDATE ON public.password_reset FOR EACH
            ROW EXECUTE FUNCTION public.handle_input(); CREATE TRIGGER trigger_increment_reset_count
            BEFORE UPDATE ON public.password_reset FOR EACH ROW EXECUTE FUNCTION
            public.increment_reset_count(); </sql>
    </changeSet>

    <!-- Add comments -->
    <changeSet id="28" author="liquibase">
        <sql> COMMENT ON TABLE public.user_pipeline_status IS 'This stores the what status / stage /
            column of a kanban board a user is in per pipeline. A user can be in more than one
            pipeline, but not in the same pipeline twice. To move a user, update the pipeline_status
            column.'; </sql>
    </changeSet>

</databaseChangeLog>